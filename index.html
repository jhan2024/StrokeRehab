<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Rehabilitation Device Interface</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🎮</text></svg>">
    <!-- Flappy Bird CSS -->
    <link rel="stylesheet" href="flappybird/css/main.css">
    <!-- Space Shooter CSS -->
    <link rel="stylesheet" href="spaceshooter/css/spaceshooter.css">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- forceChart in analyze tab -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>      
</head>

<body>
    <div class="app-container">
        <!-- Side Panel for Hardware Control -->
        <div class="side-panel">
            <h2>Hardware Control</h2>
            <div class="control-section">
                <h3>Device Status</h3>
                <div class="status-indicator connected">Connected</div>
                <button class="control-btn" id="side-panel-connect-btn">Disconnect</button>
            </div>

            <div class="control-section">
                <h3>Touch Visualization</h3>
                <!-- REMOVED Touch Display and Canvas -->
                <!-- 
                <div class="touch-display">
                    <canvas id="touchCanvas" width="200" height="200"></canvas>
                </div>
                -->
                <div class="force-levels" id="force-levels-container">
                    <!-- Force bars will be dynamically added/updated here by script.js -->
                    <!-- Example for one bar (to be managed by JS) -->
                    <div class="force-bar-wrapper" id="force-bar-wrapper-0">
                        <div class="force-bar">
                            <div class="force-level" style="height: 0%;"></div>
                        </div>
                        <div class="force-label">Force 1</div> <!-- Label can be updated by JS -->
                    </div>
                    <!-- Placeholder for Force Bar 2 (hidden by default, managed by JS) -->
                    <div class="force-bar-wrapper" id="force-bar-wrapper-1" style="display: none;">
                        <div class="force-bar">
                            <div class="force-level" style="height: 0%;"></div>
                        </div>
                        <div class="force-label">Force 2</div>
                    </div>
                    <!-- Placeholder for Force Bar 3 (hidden by default, managed by JS) -->
                    <div class="force-bar-wrapper" id="force-bar-wrapper-2" style="display: none;">
                        <div class="force-bar">
                            <div class="force-level" style="height: 0%;"></div>
                        </div>
                        <div class="force-label">Force 3</div>
                    </div>
                </div>
            </div>

            <div class="control-section">
                <h3>Settings</h3>
                <div class="setting-item">
                    <label for="sensitivity">Sensitivity</label>
                    <input type="range" id="sensitivity" min="1" max="10" value="5">
                </div>
                <div class="setting-item">
                    <label for="threshold">Force Threshold</label>
                    <input type="range" id="threshold" min="1" max="10" value="3">
                </div>
            </div>

            <button class="toggle-panel-btn">Hide Panel</button>
        </div>

        <!-- Main Panel for Exercises and Measurement -->
        <div class="main-panel">
            <div class="tabs">
                <button class="tab-btn active" data-tab="exercises">Gamified Exercises</button>
                <button class="tab-btn" data-tab="measurement">Measurement</button>
                <button class="tab-btn" data-tab="settings">Settings</button>
                <button class="tab-btn" data-tab="analysisTab">Analysis</button>
            </div>

            <!-- Exercises Tab Content -->
            <div class="tab-content active" id="exercises">
                <h2>Rehabilitation Games</h2>
                <div class="game-selection">
                    <div class="game-card" id="flappyBirdCard">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='120' viewBox='0 0 220 120'%3E%3Crect width='220' height='120' fill='%232ecc71'/%3E%3Ctext x='110' y='60' font-family='Arial' font-size='40' fill='white' text-anchor='middle' dominant-baseline='middle'%3E🐦%3C/text%3E%3C/svg%3E"
                            alt="Flappy Bird Game">
                        <h3>Flappy Bird</h3>
                        <p>Control using pressure inputs</p>
                        <button class="play-btn" id="playFlappyBird">Play</button>
                    </div>
                    <div class="game-card" id="spaceShooterCard">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='120' viewBox='0 0 220 120'%3E%3Crect width='220' height='120' fill='%233498db'/%3E%3Ctext x='110' y='60' font-family='Arial' font-size='40' fill='white' text-anchor='middle' dominant-baseline='middle'%3E🚀%3C/text%3E%3C/svg%3E"
                            alt="Space Shooter Game">
                        <h3>Space Shooter</h3>
                        <p>Vertical control with force input</p>
                        <button class="play-btn" id="playSpaceShooter">Play</button>
                    </div>
                    <div class="game-card">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='120' viewBox='0 0 220 120'%3E%3Crect width='220' height='120' fill='%23e74c3c'/%3E%3Ctext x='110' y='60' font-family='Arial' font-size='40' fill='white' text-anchor='middle' dominant-baseline='middle'%3E%F0%9F%8F%8C%EF%B8%8F%3C/text%3E%3C/svg%3E"
                            alt="Golf Game">
                        <h3>Mini Golf</h3>
                        <p>Direction + Force control (Not Implemented)</p>
                        <button class="play-btn">Play</button>
                    </div>
                    
                    <div class="game-card">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='120' viewBox='0 0 220 120'%3E%3Crect width='220' height='120' fill='%23f39c12'/%3E%3Ctext x='110' y='60' font-family='Arial' font-size='40' fill='white' text-anchor='middle' dominant-baseline='middle'%3E%F0%9F%8F%83%3C/text%3E%3C/svg%3E"
                            alt="Subway Surf Game">
                        <h3>Subway Surf</h3>
                        <p>Directional control with jumps (Not Implemented)</p>
                        <button class="play-btn">Play</button>
                    </div>

                    <div class="game-card" id="poolGameCard">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='120' viewBox='0 0 220 120'%3E%3Crect width='220' height='120' fill='%2327ae60'/%3E%3Ctext x='110' y='60' font-family='Arial' font-size='40' fill='white' text-anchor='middle' dominant-baseline='middle'%3E🎱%3C/text%3E%3C/svg%3E"
                            alt="Pool Game">
                        <h3>Pool Game</h3>
                        <p>Direction + Force control</p>
                        <button class="play-btn" id="playPoolGame">Play</button>
                    </div>
                    <div class="game-card" id="rhythmKeysCard">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='120' viewBox='0 0 220 120'%3E%3Crect width='220' height='120' fill='%239b59b6'/%3E%3Ctext x='110' y='60' font-family='Arial' font-size='40' fill='white' text-anchor='middle' dominant-baseline='middle'%3E🎹%3C/text%3E%3C/svg%3E"
                            alt="Rhythm Keys Game">
                        <h3>Rhythm Hero</h3>
                        <p>Match notes with 3-dome input</p>
                        <button class="play-btn" id="playRhythmKeys">Play</button>
                    </div>
                </div>

                <!-- Flappy Bird Game Container -->
                <div id="flappyBirdGame" style="display: none;">
                    <button id="closeFlappyBird" class="close-game-btn">Close Game</button>
                    <div id="gamecontainer">
                        <div id="gamescreen">
                            <div id="sky" class="animated">
                                <div id="flyarea">
                                    <div id="ceiling" class="animated"></div>
                                    <!-- This is the flying and pipe area container -->
                                    <div id="player" class="bird animated"></div>
                                    <div id="bigscore"></div>
                                    <div id="splash"></div>
                                    <div id="scoreboard">
                                        <div id="medal"></div>
                                        <div id="currentscore"></div>
                                        <div id="highscore"></div>
                                        <div id="replay"><img src="flappybird/assets/replay.png" alt="replay"></div>
                                    </div>
                                    <!-- Pipes go here! -->
                                </div>
                            </div>
                            <div id="land" class="animated">
                                <div id="debug"></div>
                            </div>
                        </div>
                    </div>
                    <div class="boundingbox" id="playerbox"></div>
                    <div class="boundingbox" id="pipebox"></div>
                </div>

                <!-- Space Shooter Game Container -->
                <div id="spaceShooterGame" style="display: none;">
                    <button id="closeSpaceShooter" class="close-game-btn">Close Game</button>
                    <div id="game-container">
                        <canvas id="spaceShooterCanvas" width="800" height="600"></canvas>
                        <div id="game-ui">
                            <div id="score-display">Score: <span id="current-score">0</span></div>
                            <div id="health-display">
                                <div class="health-label">Health:</div>
                                <div class="health-bar">
                                    <div class="health-fill"></div>
                                </div>
                            </div>
                            <div id="controls-help">
                                <p>Use force input to move your ship up and down!</p>
                                <p>Press SPACE to start</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pool Game Container -->
                <div id="poolGameContainer" style="display: none;">
                    <button id="closePoolGame" class="close-game-btn">Close Game</button>
                    <div id="pool-container" style="text-align: center">
                        <canvas id="poolCanvas" width="800" height="400"></canvas>
                        <div id="pool-ui">
                            <div id="pool-score-display">Shots: <span id="shots-count">0</span></div>
                            <div id="pool-controls-help">
                                <p>First 2 domes for left and right, 3rd dome determines shot power</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rhythm Keys Game Container -->
                <div id="rhythmKeysGame" style="display: none;">
                    <button id="closeRhythmKeys" class="close-game-btn">Close Game</button>
                    <div id="rhythm-keys-container" style="text-align: center; position: relative;">
                        <canvas id="rhythmKeysCanvas" width="600" height="700"></canvas>
                        <div id="rhythm-keys-ui"
                            style="position: absolute; top: 10px; left: 10px; color: white; background-color: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px;">
                            <div>Score: <span id="rhythmKeysScore">0</span></div>
                            <div>Song: <span id="rhythmKeysSongTitle">N/A</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Measurement Tab Content -->
            <div class="tab-content" id="measurement">
                <h2>Measurement</h2>
                <div class="measurement-container">
                    <div class="measurement-controls">
                        <button class="measure-btn">Start Measurement</button>
                        <button class="save-btn">Save Results</button>
                        <div class="measurement-display">
                            <h3>Current Session</h3>
                            <div class="metric">
                                <span class="metric-label">Max Force:</span>
                                <span class="metric-value">6.7 N</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Average Force:</span>
                                <span class="metric-value">4.2 N</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Duration:</span>
                                <span class="metric-value">00:02:34</span>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="forceChart" width="600" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- Analysis Tab Content -->
            <div class="tab-content" id="analysisTab">
                <h2>Press Pattern Analysis</h2>
                <!-- Upload section -->
                
                <div class="analysis-controls">
                    <!-- <input type="file" id="analysisFileInput" accept=".json" /> -->
                    <button id="analyzeBtn" class="analyze-btn">Start Analysis</button>
                    <span id="analysisSourceHint" style="margin-left: 10px; font-style: italic; color: gray;"></span>
                </div>
            
                <!-- Flex layout container -->
                <div class="flex-analysis">
                    <!-- Left Panel: Summary -->
                    <div id="summaryPanel" class="panel-left">
                        <h3 style="margin-bottom: 20px;">📊 Summary</h3>
                        <div id="analysisResult">Waiting for analysis...</div>
                    </div>

                    <!-- Right Panel: AI Feedback -->
                    <div id="feedbackPanel" class="panel-right">
                        <h3 style="margin-bottom: 20px;">💬 AI Feedback</h3>
                        <pre id="feedbackResult" style="white-space: pre-wrap;">Waiting for AI feedback...
                        </pre>
                    </div>
                </div>

                <!-- Place this AFTER </div> of flex-analysis -->
                <div class="chart-container">
                    <div id="forceChartWrapper" style="margin-top: 40px; padding: 0 40px;">
                        <h3 style="text-align:center">📈 Full Dome Press Traces</h3>

                        <div style="margin-bottom: 20px;">
                            <h4>Thumb</h4>
                            <canvas id="forceChart0" width="800" height="180"></canvas>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <h4>Index</h4>
                            <canvas id="forceChart1" width="800" height="180"></canvas>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <h4>Middle</h4>
                            <canvas id="forceChart2" width="800" height="180"></canvas>
                        </div>
                    </div>
                </div>    
                
            </div>

            <!-- Debug Tab Content -->
            <div class="tab-content" id="settingsContent">
                <h2>Device Settings</h2>
                <div class="debug-container">
                    <div class="connection-status">
                        <h3>Connection Status</h3>
                        <div class="debug-status-indicator disconnected">Disconnected</div>
                        <div class="device-type-selector" style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Device Type:</label>
                            <label for="deviceType1Dome" style="margin-right: 10px;">
                                <input type="radio" id="deviceType1Dome" name="deviceType" value="1-dome" checked>
                                1-Dome
                            </label>
                            <label for="deviceType3Dome">
                                <input type="radio" id="deviceType3Dome" name="deviceType" value="3-dome"> 3-Dome
                            </label>
                        </div>
                        <div class="connection-controls">
                            <button class="connect-btn">Connect to Arduino</button>
                            <button class="simulation-toggle">Use Simulation</button>
                        </div>
                    </div>
                    <div class="data-log-container">
                        <h3>Input Data Log</h3>
                        <div class="data-log">
                            <div class="log-controls">
                                <button class="log-btn start-log">Start Logging</button>
                                <button class="log-btn clear-log">Clear Log</button>
                            </div>
                            <div class="log-display">
                                <pre id="arduinoLog">No data received yet...</pre>
                            </div>
                        </div>
                    </div>
                    <div class="sensor-readings">
                        <h3>Live Sensor Readings</h3>
                        <div class="sensor-grid" id="sensor-grid-debug">
                            <!-- Sensor 1 Data -->
                            <div class="sensor-reading-group" id="sensor-group-0">
                                <div class="sensor-reading">
                                    <span class="sensor-label">Pressure 1 (Pa):</span>
                                    <span class="sensor-value" id="pressureValue0">0.00</span>
                                </div>
                                <div class="sensor-reading">
                                    <span class="sensor-label">Norm. Force 1:</span>
                                    <span class="sensor-value" id="normalizedForceValue0">0.000</span>
                                </div>
                            </div>
                            <!-- Sensor 2 Data (hidden by default) -->
                            <div class="sensor-reading-group" id="sensor-group-1" style="display: none;">
                                <div class="sensor-reading">
                                    <span class="sensor-label">Pressure 2 (Pa):</span>
                                    <span class="sensor-value" id="pressureValue1">0.00</span>
                                </div>
                                <div class="sensor-reading">
                                    <span class="sensor-label">Norm. Force 2:</span>
                                    <span class="sensor-value" id="normalizedForceValue1">0.000</span>
                                </div>
                            </div>
                            <!-- Sensor 3 Data (hidden by default) -->
                            <div class="sensor-reading-group" id="sensor-group-2" style="display: none;">
                                <div class="sensor-reading">
                                    <span class="sensor-label">Pressure 3 (Pa):</span>
                                    <span class="sensor-value" id="pressureValue2">0.00</span>
                                </div>
                                <div class="sensor-reading">
                                    <span class="sensor-label">Norm. Force 3:</span>
                                    <span class="sensor-value" id="normalizedForceValue2">0.000</span>
                                </div>
                            </div>
                            <!-- Shared Last Update -->
                            <div class="sensor-reading-group" id="sensor-group-last-update">
                                <div class="sensor-reading">
                                    <span class="sensor-label">Last Update:</span>
                                    <span class="sensor-value" id="lastUpdate">--:--:--</span>
                                </div>
                            </div>
                        </div>
                        <div class="calibration-controls" style="margin-top: 15px;">
                            <!-- Dome 1 Calibration Row -->
                            <div class="dome-calibration-group" id="dome-calibration-group-0">
                                <div class="calibration-item">
                                    <label for="basePressureInput0">Base P1 (Pa):</label>
                                    <input type="number" id="basePressureInput0" value="101300">
                                </div>
                                <div class="calibration-item">
                                    <label for="pressureRangeInput0">Range 1 (Pa):</label>
                                    <input type="number" id="pressureRangeInput0" value="5000">
                                </div>
                                <button class="log-btn calibrate-btn" id="calibrateZeroBtn0">Calibrate 1</button>
                            </div>

                            <!-- Dome 2 Calibration Row -->
                            <div class="dome-calibration-group" id="dome-calibration-group-1" style="display: none;">
                                <div class="calibration-item">
                                    <label for="basePressureInput1">Base P2 (Pa):</label>
                                    <input type="number" id="basePressureInput1" value="101300">
                                </div>
                                <div class="calibration-item">
                                    <label for="pressureRangeInput1">Range 2 (Pa):</label>
                                    <input type="number" id="pressureRangeInput1" value="5000">
                                </div>
                                <button class="log-btn calibrate-btn" id="calibrateZeroBtn1">Calibrate 2</button>
                            </div>

                            <!-- Dome 3 Calibration Row -->
                            <div class="dome-calibration-group" id="dome-calibration-group-2" style="display: none;">
                                <div class="calibration-item">
                                    <label for="basePressureInput2">Base P3 (Pa):</label>
                                    <input type="number" id="basePressureInput2" value="101300">
                                </div>
                                <div class="calibration-item">
                                    <label for="pressureRangeInput2">Range 3 (Pa):</label>
                                    <input type="number" id="pressureRangeInput2" value="5000">
                                </div>
                                <button class="log-btn calibrate-btn" id="calibrateZeroBtn2">Calibrate 3</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.transit/0.9.12/jquery.transit.min.js"></script>
    <script src="flappybird/assets/placeholder.js"></script>
    <script src="flappybird/js/flappybird.js"></script>
    <script src="spaceshooter/js/spaceshooter.js"></script>
    <script src="poolgame/js/poolgame.js"></script>
    <script src="rhythmkeys/js/rhythmkeys.js"></script>

    <!-- Main Scripts -->
    <script src="constants.js"></script>
    <script src="serial-simulator.js"></script>
    <script src="sensor_interface.js"></script>
    <script src="input_mode_manager.js"></script>
    <script src="measurement_manager.js"></script>
    <script src="settings_manager.js"></script>
    <script src="game_control.js"></script>
    <script src="script.js"></script>
    <script src="img-placeholders.js"></script>
</body>

</html>